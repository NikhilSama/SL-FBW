<?php 
	
$timeZones = array(
    '-660' => "(GMT-11:00) Midway Island",
    '-600' => "(GMT-10:00) Hawaii",
    '-540' => "(GMT-09:00) Alaska",
    '-480' => "(GMT-08:00) Pacific Time (US &amp; Canada)",
    '-420' => "(GMT-07:00) Mountain Time (US &amp; Canada)",
    '-360' => "(GMT-06:00) Central Time (US &amp; Canada)",
    '-300' => "(GMT-05:00) Eastern Time (US &amp; Canada)",
    '-258' => "(GMT-04:30) Caracas",
    '-240' => "(GMT-04:00) Atlantic Time (Canada)",
    '-198' => "(GMT-03:30) Newfoundland",
    '-180' => "(GMT-03:00) Buenos Aires",
    '-120' => "(GMT-02:00) Stanley",
    '-60' => "(GMT-01:00) Cape Verde Is.",
    '0' => "(GMT) London",
    '60' => "(GMT+01:00) Paris",
    '120' => "(GMT+02:00) Cairo",
    '180' => "(GMT+03:00) Riyadh",
    '210' => "(GMT+03:30) Tehran",
    '240' => "(GMT+04:00) Moscow",
    '270' => "(GMT+04:30) Kabul",
    '300' => "(GMT+05:00) Tashkent",
    '330' => "(GMT+05:30) India",
    '345' => "(GMT+05:45) Kathmandu",
    '360' => "(GMT+06:00) Almaty",
    '420' => "(GMT+07:00) Bangkok",
    '480' => "(GMT+08:00) Singapore",
    '540' => "(GMT+09:00) Tokyo",
    '570' => "(GMT+09:30) Adelaide",
    '600' => "(GMT+10:00) Sydney",
    '660' => "(GMT+11:00) Vladivostok",
    '720' => "(GMT+12:00) Auckland",
);

$countries = array(
"Afghanistan"=>"1",
"Aland Islands"=>"2",
"Albania"=>"3",
"Algeria"=>"4",
"American Samoa"=>"5",
"Andorra"=>"6",
"Angola"=>"7",
"Anguilla"=>"8",
"Antarctica"=>"9",
"Antigua and Barbuda"=>"10",
"Argentina"=>"12",
"Armenia"=>"12",
"Aruba"=>"13",
"Australia"=>"14",
"Austria"=>"15",
"Azerbaijan"=>"16",
"Bahamas"=>"17",
"Bahrain"=>"18",
"Bangladesh"=>"19",
"Barbados"=>"20",
"Belarus"=>"21",
"Belgium"=>"22",
"Belize"=>"23",
"Benin"=>"24",
"Bermuda"=>"25",
"Bhutan"=>"26",
"Bolivia"=>"27",
"Bonaire, Sint Eustatius and Saba"=>"28",
"Bosnia and Herzegovina"=>"29",
"Botswana"=>"30",
"Bouvet Island"=>"31",
"Brazil"=>"32",
"British Indian Ocean Territory"=>"33",
"Brunei"=>"34",
"Bulgaria"=>"35",
"Burkina Faso"=>"36",
"Burundi"=>"37",
"Cambodia"=>"38",
"Cameroon"=>"39",
"Canada"=>"40",
"Cape Verde"=>"41",
"Cayman Islands"=>"42",
"Central African Republic"=>"43",
"Chad"=>"44",
"Chile"=>"45",
"China"=>"46",
"Christmas Island"=>"47",
"Cocos (Keeling) Islands"=>"48",
"Colombia"=>"49",
"Comoros"=>"50",
"Congo"=>"51",
"Cook Islands"=>"52",
"Costa Rica"=>"53",
"Cote d''ivoire (Ivory Coast)"=>"54",
"Croatia"=>"55",
"Cuba"=>"56",
"Curacao"=>"57",
"Cyprus"=>"58",
"Czech Republic"=>"59",
"Democratic Republic of the Congo"=>"60",
"Denmark"=>"61",
"Djibouti"=>"62",
"Dominica"=>"63",
"Dominican Republic"=>"64",
"Ecuador"=>"65",
"Egypt"=>"66",
"El Salvador"=>"67",
"Equatorial Guinea"=>"68",
"Eritrea"=>"69",
"Estonia"=>"70",
"Ethiopia"=>"71",
"Falkland Islands (Malvinas)"=>"72",
"Faroe Islands"=>"73",
"Fiji"=>"74",
"Finland"=>"75",
"France"=>"76",
"French Guiana"=>"77",
"French Polynesia"=>"78",
"French Southern Territories"=>"79",
"Gabon"=>"80",
"Gambia"=>"81",
"Georgia"=>"82",
"Germany"=>"83",
"Ghana"=>"84",
"Gibraltar"=>"85",
"Greece"=>"86",
"Greenland"=>"87",
"Grenada"=>"88",
"Guadaloupe"=>"89",
"Guam"=>"90",
"Guatemala"=>"91",
"Guernsey"=>"92",
"Guinea"=>"93",
"Guinea-Bissau"=>"94",
"Guyana"=>"95",
"Haiti"=>"96",
"Heard Island and McDonald Islands"=>"97",
"Honduras"=>"98",
"Hong Kong"=>"99",
"Hungary"=>"100",
"Iceland"=>"101",
"India"=>"102",
"Indonesia"=>"103",
"Iran"=>"104",
"Iraq"=>"105",
"Ireland"=>"106",
"Isle of Man"=>"107",
"Israel"=>"108",
"Italy"=>"109",
"Jamaica"=>"110",
"Japan"=>"111",
"Jersey"=>"112",
"Jordan"=>"113",
"Kazakhstan"=>"114",
"Kenya"=>"115",
"Kiribati"=>"116",
"Kosovo"=>"117",
"Kuwait"=>"118",
"Kyrgyzstan"=>"119",
"Laos"=>"120",
"Latvia"=>"121",
"Lebanon"=>"122",
"Lesotho"=>"123",
"Liberia"=>"124",
"Libya"=>"125",
"Liechtenstein"=>"126",
"Lithuania"=>"127",
"Luxembourg"=>"128",
"Macao"=>"129",
"Macedonia"=>"130",
"Madagascar"=>"131",
"Malawi"=>"132",
"Malaysia"=>"133",
"Maldives"=>"134",
"Mali"=>"135",
"Malta"=>"136",
"Marshall Islands"=>"137",
"Martinique"=>"138",
"Mauritania"=>"139",
"Mauritius"=>"140",
"Mayotte"=>"141",
"Mexico"=>"142",
"Micronesia"=>"143",
"Moldava"=>"144",
"Monaco"=>"145",
"Mongolia"=>"146",
"Montenegro"=>"147",
"Montserrat"=>"148",
"Morocco"=>"149",
"Mozambique"=>"150",
"Myanmar (Burma)"=>"151",
"Namibia"=>"152",
"Nauru"=>"153",
"Nepal"=>"154",
"Netherlands"=>"155",
"New Caledonia"=>"156",
"New Zealand"=>"157",
"Nicaragua"=>"158",
"Niger"=>"159",
"Nigeria"=>"160",
"Niue"=>"161",
"Norfolk Island"=>"162",
"North Korea"=>"163",
"Northern Mariana Islands"=>"164",
"Norway"=>"165",
"Oman"=>"166",
"Pakistan"=>"167",
"Palau"=>"168",
"Palestine"=>"169",
"Panama"=>"170",
"Papua New Guinea"=>"171",
"Paraguay"=>"172",
"Peru"=>"173",
"Phillipines"=>"174",
"Pitcairn"=>"175",
"Poland"=>"176",
"Portugal"=>"177",
"Puerto Rico"=>"178",
"Qatar"=>"179",
"Reunion"=>"180",
"Romania"=>"181",
"Russia"=>"182",
"Rwanda"=>"183",
"Saint Barthelemy"=>"184",
"Saint Helena"=>"185",
"Saint Kitts and Nevis"=>"186",
"Saint Lucia"=>"187",
"Saint Martin"=>"188",
"Saint Pierre and Miquelon"=>"189",
"Saint Vincent and the Grenadines"=>"190",
"Samoa"=>"191",
"San Marino"=>"192",
"Sao Tome and Principe"=>"193",
"Saudi Arabia"=>"194",
"Senegal"=>"195",
"Serbia"=>"196",
"Seychelles"=>"197",
"Sierra Leone"=>"198",
"Singapore"=>"199",
"Sint Maarten"=>"200",
"Slovakia"=>"201",
"Slovenia"=>"202",
"Solomon Islands"=>"203",
"Somalia"=>"204",
"South Africa"=>"205",
"South Georgia and the South Sandwich Islands"=>"206",
"South Korea"=>"207",
"South Sudan"=>"208",
"Spain"=>"209",
"Sri Lanka"=>"210",
"Sudan"=>"211",
"Suriname"=>"212",
"Svalbard and Jan Mayen"=>"213",
"Swaziland"=>"214",
"Sweden"=>"215",
"Switzerland"=>"216",
"Syria"=>"217",
"Taiwan"=>"218",
"Tajikistan"=>"219",
"Tanzania"=>"220",
"Thailand"=>"221",
"Timor-Leste (East Timor)"=>"222",
"Togo"=>"223",
"Tokelau"=>"224",
"Tonga"=>"225",
"Trinidad and Tobago"=>"226",
"Tunisia"=>"227",
"Turkey"=>"228",
"Turkmenistan"=>"229",
"Turks and Caicos Islands"=>"230",
"Tuvalu"=>"231",
"Uganda"=>"232",
"Ukraine"=>"233",
"United Arab Emirates"=>"234",
"United Kingdom"=>"235",
"United States"=>"236",
"United States Minor Outlying Islands"=>"237",
"Uruguay"=>"238",
"Uzbekistan"=>"239",
"Vanuatu"=>"240",
"Vatican City"=>"241",
"Venezuela"=>"242",
"Vietnam"=>"243",
"Virgin Islands, British"=>"244",
"Virgin Islands, US"=>"245",
"Wallis and Futuna"=>"246",
"Western Sahara"=>"247",
"Yemen"=>"248",
"Zambia"=>"249",
"Zimbabwe"=>"250"

);

$video_count = 0;
$album_count = 0;
$photo_count = 0;
$event_count = 0;
$post_count = 0;

	//function to send post request
	function curlreq($data,$url)
	{
		$ch = curl_init();
		$curlConfig = array(
		    CURLOPT_URL            => $url,
		    CURLOPT_POST           => true,
		    CURLOPT_RETURNTRANSFER => true,
		    CURLOPT_POSTFIELDS     => $data
		);
		curl_setopt_array($ch, $curlConfig);
		$result = curl_exec($ch);
		curl_close($ch);
		return $result;
	}


	//fucntion to get apptabs
	function get_apptabs($page_id)
	{	
		global $db;
		$apptab_query_string = "select apptab_name, apptab_id from ".APPTAB_ID." where page_id = ".$page_id;
		$apptab_data = $db->execute_query($apptab_query_string);
		// file_put_contents("data.txt", json_encode($apptab_data));
		// var_dump($apptab_data);
		// die();
		$apptabs = array();
		foreach ($apptab_data as $apptab)
		{	
			$apptabs[$apptab['apptab_name']] = $apptab['apptab_id'];
		}
		$encoded_apptabs = json_encode($apptabs);
		// file_put_contents("data.txt", $encoded_apptabs);
		
		return $apptabs;
	}


	function extract_post_data($posts_data,$apptabs)
	{	
		// global $apptabs;
		global $post_count;
		global $mobapp_id;
		global $posts;
		global $fbObject;

		if( !empty($posts_data) )
		{
			foreach ($posts_data['data'] as $post_info) 
			{	
				// if( !strpos($post_info['story'], 'created an event') )
				if( !strpos($post_info['story'], 'created an event') )
				{	
					$post_count++;
					$post = array();
					$post['apptab_id'] =  $apptabs['Fan Wall'];
	                $post['mobapp_id'] =  $mobapp_id;

	        		//we are using if blocks because we cannot send a blank field in the array which makes it not to post        
	                if( !empty($post_info['message']) ) 
	                {
	                	$post['post'] =  $post_info['message'];    //message
	                } else if( !empty($post_info['story']) )
	                {
	                	$post['post'] =  $post_info['story'];  
	                }

	                if( !empty($post_info['picture']) ) 
	                {
	                	$post['thumbImg'] = $post_info['picture'];   //thumb image
	                	$post['img'] = $post_info['picture'];   //thumb image
	                }

	                if( !empty($post_info['full_picture']) ) 
	                {	
	                	//large image
	                	$post['img'] =  $post_info['full_picture'];
	                }

	                if( !empty($post_info['created_time']) )
	                {
	                	$post['created'] = $post_info['created_time'];
	                }

	                if( !empty($post_info['source']) ) 
	                {
	                	$post['video_url'] =  $post_info['source'];  // video url
	                }

	                if( !empty($post_info['place']['location']['latitude']) )
	                {
	                	$post['latitude'] = $post_info['place']['location']['latitude'];
	                }

	                if( !empty($post_info['place']['location']['longitude']) ) 
	                {
	                	$post['longitude'] = $post_info['place']['location']['longitude'];
	                }

	                if( !empty($post_info['id']) ) 
	                {
	                	$post['post_id'] = $post_info['id'];
	                }

	                $posts[] = $post;
                } //check for relevant type ends
			} //loop ends
		} //if block ends

		if( !empty($posts_data['paging']['next']) )
		{
			//checking if the next link of the data exists
			$link  = $posts_data['paging']['next'];

			//feeding the api with the paging next string
			$link = str_replace("https://graph.facebook.com", "", $link);

			$data = $fbObject->api($link);
			if(!empty($data))
			{	
				//calling the same function until the next link contains data
				extract_post_data($data,$apptabs);				
			}
		}
	} //function extract_post_data ends 


	
	function extract_page_info($pageinfo, $picture_small,$apptabs)
	{	
		// file_put_contents("data.txt", json_encode($pageinfo));    
		//works
		
		global $mobapp_id;
		//make fbobject , bio array and location global in  order to make it accessible inside function
		global $fbObject;
		global $bio;
		global $location;
		global $countries;
		$info = array();
		
		$info['original_data'] = $pageinfo;

		$bioContent = "";
		if(isset($pageinfo['about']) && !empty($pageinfo['about']) ) {
			$bioContent .= "<div><strong>About : </strong> <br><span>" . $pageinfo['about'] . "</span></div><br>";
		}

		if(isset($pageinfo['bio']) && !empty($pageinfo['bio']) ) {
			$bioContent .= "<div><strong>Bio : </strong> <br><span>" . $pageinfo['bio'] . "</span></div><br>";
		}

		if(isset($pageinfo['description']) && !empty($pageinfo['description']) ) {
			$bioContent .= "<div><strong>Description : </strong> <br><span>" . $pageinfo['description'] . "</span></div><br>";
		}

		if(isset($pageinfo['phone']) && !empty($pageinfo['phone']) ) {
			$bioContent .= "<div><strong>Phone : </strong> <br><span>" . $pageinfo['phone'] . "</span></div><br>";
		}

		if(isset($pageinfo['website']) && !empty($pageinfo['website']) ) {
			$bioContent .= "<div><strong>Website : </strong> <br><span>" . $pageinfo['website'] . "</span></div><br>";
		}

		if(isset($pageinfo['emails']) && !empty($pageinfo['emails']) ) {
			if(is_array($pageinfo['emails'])) {
				$bioContent .= "<div><strong>Email : </strong> <br><span>" . implode(', ', $pageinfo['emails']) . "</span></div><br>";
			} else {
				$bioContent .= "<div><strong>Email : </strong> <br><span>" . $pageinfo['emails'] . "</span></div><br>";
			}
		}

		if(isset($pageinfo['press_contact']) && !empty($pageinfo['press_contact']) ) {
			$bioContent .= "<div><strong>Press Contact : </strong> <br><span>" . $pageinfo['press_contact'] . "</span></div><br>";
		}

		if(isset($pageinfo['booking_agent']) && !empty($pageinfo['booking_agent']) ) {
			$bioContent .= "<div><strong>Booking Agent : </strong> <br><span>" . $pageinfo['booking_agent'] . "</span></div><br>";
		}

		if(isset($pageinfo['general_manager']) && !empty($pageinfo['general_manager']) ) {
			$bioContent .= "<div><strong>General Manager : </strong> <br><span>" . $pageinfo['general_manager'] . "</span></div><br>";
		}

		$info['content'] = $bioContent;
		
		// $info['img'] = "http://graph.facebook.com/".$page_id."/picture?height=300&width=600";

		if (!empty($pageinfo['cover']['source']) ) 
		{
			$info['img'] = $pageinfo['cover']['source'];
		}

		if( !empty($picture_small['picture']['data']['url']) ) 
		{
			$info['imgThumb'] = $picture_small['picture']['data']['url'];
		}

		$info['mobapp_id'] = $mobapp_id;
		$info['apptab_id'] = $apptabs['About'];
		$bio[] = $info;

		// file_put_contents("data.txt", json_encode($info));
		//works

		$location_info = array();
		$location_info['apptab_id'] = $apptabs['Locations'] ;
		$location_info['mobapp_id'] = $mobapp_id ;
		// $location_info['currency_id'] =  '';
		// $location_info['branch'] ;
		// $location_info['country'] ;
		// $location_info['country_id'] = $countries[$location_info['country']];

		if(!empty($pageinfo['location']['country']))
	    {
	       	$location_info['country_id'] =  $countries[$pageinfo['location']['country']];
	    } else{
			$location_info['country_id']=102;
		}

		if( !empty($pageinfo['emails']) ) 
		{
			if(is_array($pageinfo['emails'])) {
				$location_info['email'] = implode(', ', $pageinfo['emails']);
			} else {
				$location_info['email'] = $pageinfo['emails'];
			}
		}

		

		if( !empty($pageinfo['location']['street']) ) 
		{
			$location_info['address1'] = $pageinfo['location']['street'] ;
		}

		if( !empty($pageinfo['location']['city']) ) 
		{
			$location_info['city'] = $pageinfo['location']['city'] ;
		} 

		if( !empty($pageinfo['location']['state']) ) 
		{
			$location_info['state'] = $pageinfo['location']['state'];
		} 

		
		if( !empty($pageinfo['location']['phone']) ) 
		{
			$location_info['phone'] = $pageinfo['location']['phone'];
		} elseif(!empty($pageinfo['phone'])) {
			$location_info['phone'] = $pageinfo['phone'];
		}

		if( !empty($pageinfo['location']['latitude']) ) 
		{
			$location_info['latitude'] = $pageinfo['location']['latitude'];
		} 

		if( !empty($pageinfo['location']['longitude']) ) 
		{
			$location_info['longitude'] = $pageinfo['location']['longitude'];
		}

		if( !empty($pageinfo['location']['zip']) ) 
		{
			$location_info['zipcode'] = $pageinfo['location']['zip'];
		} 

		if( !empty($pageinfo['location']) )
		{
			if( !empty($pageinfo['name']) ) 
			{
				$location_info['name'] = $pageinfo['name'];
			}
			$location[] = $location_info;

		}
		
		// print_r($location);
	}	//extract_page_info function ends




	//an array that would contain the pagination photos and be later merged to create single array
	$additional_photos_array = array();

	//this is the function to extract additional photos in case of pagination in photos
	function extract_additional_photos($data)
	{	
		global $fbObject;
		global $photo_count;
		global $additional_photos_array;
		foreach ($data['data'] as $photo_data)
		{
			$photo_count++;
			$photo = array();
			//getting all the attributes of the image
			$photo['class'] = 'Album';

			if( !empty($photo_data['picture']) ) 
			{
				$photo['thumbImg'] = $photo_data['picture'];
			}

			if( !empty($photo_data['created_time']) )
			{
				$photo['created'] = $photo_data['created_time'];
			}

			if( !empty($photo_data['source']) ) 
			{
				$photo['largeImg'] = $photo_data['source'];
			} 

			if( !empty($photo_data['name']) ) 
			{
				$photo['caption'] = $photo_data['name'];
			}
			$additional_photos_array[] = $photo;

		}
		if( !empty($data['paging']['next']) )
		{
			$link = $data['paging']['next'];
			$link = str_replace("https://graph.facebook.com", "", $link);
			$new_data = $fbObject->api($link);
			extract_additional_photos($new_data);
			return $additional_photos_array;
		} else
		{
			return $additional_photos_array;
		}
	}

	// function extractPhotoUpdate($albums_data,$apptab_data)
	// {	
	// 	global $album_count;
	// 	global $photo_count;
	// 	$flag = 1;
	// 	global $db;
	// 	global $albums;
	// 	global $fbObject;
	// 	foreach ($albums_data['albums']['data'] as $album_info) 
	// 	{
	// 		$album_count++;
	// 		$album = array();
	// 		$album['mobapp_id'] = $apptab_data['mobapp_id'];
	// 		$album['apptab_id'] = $apptab_data['apptab_id'];

	// 		if( !empty($album_info['name']) ) 
	// 		{
	// 			$album['albumName'] = $album_info['name'];
	// 		}

	// 		if( !empty($album_info['id']) ) 
	// 		{
	// 			$album['facebookAlbumId'] = $album_info['id'];
	// 		}

	// 		//checking if the album contains photos , if then extracting info of all the photos
	// 		if( !empty($album_info['photos']['data']) )
	// 		{	

	// 			$photos = array();
	// 			foreach ($album_info['photos']['data'] as $photo_info) 
	// 			{	
	// 				$photo_count++;
	// 				/*if( strtotime($photo_info['created_time']) > strtotime($apptab_data['timestamp']) )
	// 				{*/	

	// 					//setting the flag if a new photo has been added
	// 					$flag = 1;
	// 					$photo = array();
	// 					//getting all the attributes of the image
	// 					$photo['class'] = 'Album';

	// 					if( !empty($photo_info['picture']) ) 
	// 					{
	// 						$photo['thumbImg'] = $photo_info['picture'];
	// 					}

	// 					if( !empty($photo_info['created_time']) )
	// 					{
	// 						$photo['created'] = $photo_info['created_time'];
	// 					}

	// 					if( !empty($photo_info['source']) ) 
	// 					{
	// 						$photo['largeImg'] = $photo_info['source'];
	// 					} 

	// 					if( !empty($photo_info['name']) ) 
	// 					{
	// 						$photo['caption'] = $photo_info['name'];
	// 					}

	// 					$photos[] = $photo;
					
	// 				/*} else
	// 				{
	// 					break;
	// 				}*/
					
	// 			} // loop ends  for photos
	// 			if( !empty($album_info['photos']['paging']['next']) )
	// 			{
	// 				$link = $album_info['photos']['paging']['next'];
	// 				$link = str_replace("https://graph.facebook.com", "", $link);
	// 				$data = $fbObject->api($link);
	// 				$additional_photos = array();
	// 				$additional_photos = extract_additional_photos($data);
	// 				$photos = array_merge($photos,$additional_photos);
	// 			}
	// 			$album['Photo'] = $photos;
	// 		}
	// 		$albums[] = $album;
			

	// 	} // loop ends  for albums
		

	// 	//checking if the pagination link exists for the album
	// 	// if( !empty($album_info['paging']['next']) )
	// 	// {	

	// 	// 	//checking if the next link of the data exists
	// 	// 	$link  = $album_info['paging']['next'];

	// 	// 	//feeding the api with the paging next string
	// 	// 	$link = str_replace("https://graph.facebook.com", "", $link);

	// 	// 	$data = $fbObject->api($link);
	// 	// 	if(!empty($data))
	// 	// 	{	
	// 	// 		//calling the same function until the next link contains data
	// 	// 		extractPhotoUpdate($data,$apptab_data);
	// 	// 	}
	// 	// }

	// 	//updating the table with the latest update time
	// 	// if($flag == 1)
	// 	// {	
	// 	// 	$mobapp_id = $apptab_data['mobapp_id'];
	// 	// 	$update_query="UPDATE ".APPTAB_ID." set timestamp = now()  where mobapp_id=".$mobapp_id." and apptab_name='Photos'";
	// 	// 	$db->execute_query($update_query);
	// 	// }

	// }


	function extractPhotoUpdate($albumPhotos,$apptabs)
	{	
		// global $apptabs;
		global $album_count;
		global $photo_count;
		global $mobapp_id;
		global $albums;
		global $fbObject;

		if( !empty($albumPhotos) )
		{
			foreach ($albumPhotos as $album_info) 
			{	
				$album_count++;
				$album = array();
				$album['mobapp_id'] = $mobapp_id;
				$album['apptab_id'] = $apptabs['Photos'];

				if( !empty($album_info['name']) ) 
				{
					$album['albumName'] = $album_info['name'];
				}

				if( !empty($album_info['object_id']) ) 
				{
					$album['facebookAlbumId'] = $album_info['object_id'];
				}

				//checking if the album contains photos , if then extracting info of all the photos
				if( !empty($album_info['photos']) )
				{	
					
					$photos = array();
					foreach ($album_info['photos'] as $photo_info) 
					{	
						$photo_count++;
						$photo = array();
						//getting all the attributes of the image
						$photo['class'] = 'Album';

						if( !empty($photo_info['src']) ) 
						{
							$photo['thumbImg'] = $photo_info['src'];
						}

						if( !empty($photo_info['created']) )
						{
							$photo['created'] = $photo_info['created'];
						}

						if( !empty($photo_info['src_big']) ) 
						{
							$photo['largeImg'] = $photo_info['src_big'];
						} 

						if( !empty($photo_info['caption']) ) 
						{
							$photo['caption'] = $photo_info['caption'];
						}

						//checking if there exists pagination for the photos
						
						$photos[] = $photo;
						
					}
					$album['Photo'] = $photos;
				}
				$albums[] = $album;

			} // loop ends  for albums

			// updating the table with the latest update time
			if($flag == 1)
			{	
				$mobapp_id = $apptabs['mobapp_id'];
				$update_query="UPDATE ".APPTAB_ID." set timestamp = now()  where mobapp_id=".$mobapp_id." and apptab_name='Photos'";
				$db->execute_query($update_query);
			}
		}
	}
	

	function extractEventUpdate($events_data,$apptab_data)
	{
		global $event_count;
		global $timeZones;
		global $events;
		global $fbObject;
		global $db;
		
		if( !empty($events_data) ) 
		{
			//looping through various events
			foreach ($events_data as $event_info)
			{	
				$event_count++;
				//checkng through the data if they are empty or not if not they are assigned
				$event = array();
				$event['apptab_id'] = $apptabs['Events'];     //apptab id
	            $event['mobapp_id'] = $mobapp_id;	//mobapp id

	 			//if we send an empty value to the snaplion api data will not be posted so if blocks are used
	            if( !empty($event_info['name']) ) 
	            {
	            	$event['title'] = $event_info['name'];
	            }

	            if(!empty($event_info['description'])) 
	            {
	            	$event['description'] = $event_info['description'];
	            }

				if( !empty($event_info['start_time']) ) {
		            if(strpos($event_info['start_time'], 'T') === false) {
						$event['startDate'] = $event_info['start_time'];	
					} else {
						list($start_date, $start_time) = explode("T", $event_info['start_time']);
						$start_time = substr($start_time, 0, 8); 
						$event['startDate'] = $start_date.' '.$start_time;
					}
				}
				
				if(isset($event_info['end_time'])) {
					if(strpos($event_info['end_time'], 'T') === false) {
					    $event['endDate'] = $event_info['start_time']; 
			   		} else {
					    list($start_date, $start_time) = explode("T", $event_info['end_time']);
					    $start_time = substr($start_time, 0, 8); 
					    $event['endDate'] = $start_date.' '.$start_time;
					}
				} else {
					$event['endDate'] = date('Y-m-d H:i:s', strtotime($event['startDate']  . ' + 3 hours'));
				}
				
				// $tempTimeZone = substr($event_info['start_time'], -5, 5);
				// $event['timezone'] = ($tempTimeZone / 100) * 60;
	          
	            $event['timezone'] = 0;
	            if( !empty($event_info['timezone']) ) 
	            {	
	            	$dtz = new DateTimeZone( $event_info['timezone'] );
	    			$temp_time = new DateTime('now', $dtz);
					$offset = $dtz->getOffset( $temp_time ) / 60;
	    			$event['timezone'] = $offset;

	    			//$event['timezone'] = $timeZones[$offset];
	            	// $event['timezone'] = $event_info['timezone'];
	            }

	               // facebook event id
	            if( !empty($event_info['eid']) ) 
	            {
	            	$event['fbId'] = $event_info['eid'];
	            }

	            //venue beig itself an array in facebook api
	            // $event['venue'] = ;
	            // print_r($event_info['venue']);
				// die();
				if( !empty($event_info['venue']['name']) )
	            {
	            	$event['venue'] = $event_info['venue']['name'];
	            } else if( !empty($event_info['venue']['id']) )
	            {	
	            	$id = $event_info['venue']['id'];
	            	$data = $fbObject->api($id."?fields=name");
	            	$event['venue'] = $data['name'];
	            }

	            if( !empty($event_info['venue']['latitude']) ) 
	            {
	            	$event['latitude'] = $event_info['venue']['latitude'];
	            }
	            
	            if( !empty($event_info['venue']['city']) )
	            {
	            	$event['city'] = $event_info['venue']['city'];
	            }

	            if( !empty($event_info['venue']['longitude']) ) 
	            {
	            	$event['longitude'] = $event_info['venue']['longitude'];
	            }
	            // echo "helllo".$event_info['venue']['country'];
	            if(!empty($event_info['venue']['country']))
	            {
	            	$event['country_id'] =  $countries[$event_info['venue']['country']];
	            } else
	            {
	            	$event['country_id'] =102;
	            }

	            // echo "country".$event['country_id'];
	            
     			
	            if( !empty($event_info['ticket_uri']) ) 
	            {
	            	$event['ticketURL'] = $event_info['ticket_uri'];
	            }

	            if( !empty($event_info['pic_big']) ) 
	            {
	            	$event['imgThumb'] = $event_info['pic_big'];
	            }
	                   
	            if( !empty($event_info['pic_cover']) ) 
	            {
	            	$event['img'] = $event_info['pic_cover']['source'];
	            }

	            // $event['imgThumb'] = ( !empty($events['']) ) ? $events[''] : ''; 
	            $event['event_info'] = $event_info;
	            $events[] = $event;
			}
			//loop ends
			
		}

		/*if( !empty($event_info['paging']['next']) )
		{	
			//checking if the next link of the data exists
			$link  = $event_info['paging']['next'];

			//feeding the api with the paging next string
			$link = str_replace("https://graph.facebook.com", "", $link);

			$data = $fbObject->api($link);
			if(!empty($data))
			{	
				//calling the same function until the next link contains data
				extractEventUpdate($data,$apptab_data);
			}
				
		}*/

		//updating the table with the latest update time
		if($flag == 1)
		{	
			$mobapp_id = $apptab_data['mobapp_id'];
			$db->execute_query("Update ".APPTAB_ID." set timestamp = now()  where mobapp_id=".$mobapp_id." and apptab_name='Events' ");
		}

	}
	

	function extractVideoUpdate($video_data,$apptab_data)
	{	
		global $video_count;
		$flag = 0;
		global $videos;
		global $mobapp_id;
		global $section;
		global $fbObject;
		global $db;

		//checking if the video_data contains any videos 
		if( !empty($video_data['videos']['data']) )
		{
			foreach ( $video_data['videos']['data'] as $video_info ) 
			{	
					$video_count++;
				/*if( strtotime($video_info['updated_time']) > strtotime($apptab_data['timestamp']) )
				{*/	
					//setting the flag if a new video has been added
					$flag = 1;
					
					$video = array();
					//assigning the mobapp_id and apptab_id
					$video['mobapp_id'] = $mobapp_id;
					
					$video['apptab_id'] = $apptab_data['apptab_id'];
					
					//assigning other attributes to the video array
					if( !empty($video_info['id']) )
					{
						$video['videoId'] = $video_info['id'];
					}
					
					if( !empty($video_info['description']) )
					{
						$video['videoTitle'] = $video_info['description'];
					}
					
					if( !empty($video_info['created_time']) )
					{
						$video['created'] = $video_info['created_time'];
					}

					if( !empty($video_info['source']) )
					{
						$video['videoURL'] = $video_info['source'];
					}
					
					if( !empty($video_info['from']['id']) )
					{
						$video['fb_id'] = $video_info['from']['id'];
					}
					
					if( !empty($video_info['picture']) )
					{
						$video['videoThumbURL'] = $video_info['picture'];
					}
					
					$video['autoUpdate'] = 0;

					$videos[] = $video;
					
				//} //loop ends for videos
			}
				
			
			//checking if the pagination link exists for the album
			if( !empty($video_data['paging']['next']) )
			{
				//checking if the next link of the data exists
				$link  = $video_data['paging']['next'];

				//feeding the api with the paging next string
				$link = str_replace("https://graph.facebook.com", "", $link);

				$data = $fbObject->api($link);
				if(!empty($data))
				{	
					//calling the same function until the next link contains data
					extractVideoUpdate($data,$apptab_data);
				}
			}

		} //if block ends

		//updating the table with the latest update time
		if($flag == 1)
		{	
			$mobapp_id = $apptab_data['mobapp_id'];
			$db->execute_query("Update ".APPTAB_ID." set timestamp = now()  where mobapp_id=".$mobapp_id." and apptab_name='Videos' ");
		}

	}



	


	function checkData($page_id)
	{	
		//here we declare all the global variables
		global $event_count;
		global $album_count;
		global $photo_count;
		global $video_count;
		global $events;
		$db = new db_connect();
		global $videos;
		global $albums;
		global $mobapp_id;
		global $section;
		global $bio;
		global $location;
		if( !empty($events) )
		{	
			$section['Event'] = $events;
			$db->execute_query("UPDATE ".APPTAB_ID." set item_count = ".count($events)." where page_id=".$page_id." and apptab_name='Events' ");
			$events = '';
		}
		if( !empty($albums) )
		{	
			$section['Album'] = $albums;

			$photoCount = 0;
			foreach ($albums as $album) {
				$photoCount += count($album['Photo']);
			}
			$db->execute_query("UPDATE ".APPTAB_ID." set item_count = ".count($albums).", subitem_count = ".$photoCount." where page_id=".$page_id." and apptab_name='Photos' ");
			// $db->execute_query("UPDATE ".APPTAB_ID." set item_count = ".$album_count.", subitem_count = ".$photo_count." where page_id=".$page_id." and apptab_name='Photos' ");
			$albums = '';
			
		}
		if( !empty($videos) )
		{
			$section['Video'] = $videos;
			$db->execute_query("UPDATE ".APPTAB_ID." set item_count = ".count($videos)." where page_id=".$page_id." and apptab_name='Videos' ");
			$videos = '';
		}

		if(!empty($bio) ) {
			$section['Bio'] = $bio;
		}

		if( !empty($location) ) {	
			$section['Location'] = $location;
		}

		$data =  array();
		$data['key'] = KEY;
		$data['mobapp_id'] = $mobapp_id;
		$data['section'] = $section;

		submitData($data);
	}
	


	//to send the post request 
	function submitData($data)
	{
		$url = ADD_DATA_URL;

		// use key 'http' even if you send the request to https://...
		$options = array(
		    'http' => array(
		        'header'  => "Content-type: application/x-www-form-urlencoded\r\n",
		        'method'  => 'POST',
		        'content' => http_build_query($data),
		    ),
		);
		$context  = stream_context_create($options);
		$result = file_get_contents($url, false, $context);
		$result_data = json_decode($result,true);

		// print_r($data);
		var_dump($result_data['result']['status']);
		if( $result_data['result']['status'] )
		{	
			echo "data has been submitted";
		} else
		{
			echo "there was an error while submitting your data";
		}
		
	}